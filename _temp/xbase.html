<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta name="author" content="Nick T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabView</title>
    <script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.5.1.min.js"></script>


    <!-- DevExtreme themes -->
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/19.2.7/css/dx.common.css">
    <link rel="stylesheet" type="text/css" href="https://cdn3.devexpress.com/jslib/19.2.7/css/dx.dark.compact.css"/>
    <!-- <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/19.2.4/css/dx.material.teal.dark.compact.css"> -->
    <!-- <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/19.2.4/css/dx.contrast.compact.css"> -->
    <!-- <link rel="stylesheet" href="dx.material.dark.css"> -->

    <!-- Syncfusion theme -->
    <link href="http://cdn.syncfusion.com/18.1.0.42/js/web/flat-azure/ej.web.all.min.css" rel="stylesheet" type="text/css" />
    <!-- <link href="http://cdn.syncfusion.com/18.1.0.42/js/web/flat-lime-dark/ej.theme.min.css" rel="stylesheet" /> -->
    <link href="http://cdn.syncfusion.com/18.1.0.42/js/web/high-contrast-01/ej.theme.min.css" rel="stylesheet" />
    <!-- <script src="http://cdn.syncfusion.com/js/assets/external/jquery-3.0.0.min.js" type="text/javascript"></script> -->
    <script src="http://cdn.syncfusion.com/18.1.0.42/js/web/ej.web.all.min.js" type="text/javascript"></script>
    <script src="http://cdn.syncfusion.com/js/assets/external/jsrender.min.js" type="text/javascript"></script>


    <!-- DevExtreme library -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/19.2.4/js/dx.all.js"></script> -->
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/19.2.4/js/dx.web.js"></script>
    <!-- <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/19.2.4/js/dx.viz.js"></script> -->
    <!-- <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/19.2.4/js/dx.viz-web.js"></script> -->


    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://unpkg.com/popper.js@1.14/dist/umd/popper.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/navio/dist/navio.min.js"></script>
    <!-- <script type="text/javascript" src="data.js"></script> -->

    <script src="https://unpkg.com/@finos/perspective/dist/umd/perspective.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer/dist/umd/perspective-viewer.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer-hypergrid/dist/umd/perspective-viewer-hypergrid.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer-d3fc/dist/umd/perspective-viewer-d3fc.js"></script>
    <link rel='stylesheet' href="https://unpkg.com/@finos/perspective-viewer@0.9.0/dist/umd/material-dense.dark.css">


    <!-- Pivottablejs library -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.css">
<!--     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script> -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
<!--     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/d3_renderers.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/c3_renderers.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/export_renderers.min.js"></script>

    <!--
    <script src="https://unpkg.com/@finos/perspective/dist/umd/perspective.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer/dist/umd/perspective-viewer.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer-datagrid/dist/umd/perspective-viewer-datagrid.js"></script>
    <script src="https://unpkg.com/@finos/perspective-viewer-d3fc/dist/umd/perspective-viewer-d3fc.js"></script>-->
    <!-- <link rel='stylesheet' href="xgrivot.css"> -->
    <style>
        text {
            color: ghostwhite;
        }

        .node {
          border: solid 1px white;
          font: 10px sans-serif;
          line-height: 12px;
          overflow: hidden;
          position: absolute;
          text-indent: 2px;
        }
        .c3-line, .c3-focused {stroke-width: 3px !important;}
        .c3-bar {stroke: white !important; stroke-width: 1;}
        .c3 text { font-size: 12px; color: grey;}
        .tick line {stroke: white;}
        .c3-axis path {stroke: grey;}
        .c3-circle { opacity: 1 !important; }
        .c3-xgrid-focus {visibility: hidden !important;}
    </style>
</head>


<body style="background-color: #1f2124">
<!-- Placeholder for the widget -->
<div>
    <div id="nvxContainer">
        <div style="background-color: #515151" id="nvx"></div>
    </div>
</div>

<hr/>
<div class="d-block justify-content-center">
    <button id="btn_togrid" type="button" class="btn btn-primary">ðŸ”½ XGrid</button>
    <button id="btn_tobox" type="button" class="btn btn-primary">ðŸ”¼ XBox</button>
    <button id="btn_toejpivot" type="button" class="btn btn-primary">ðŸ”¢ EJPivot</button>
    <button id="btn_topivot" type="button" class="btn btn-primary">ðŸ”› XPivot</button>
    <button id="btn_topsp" type="button" class="btn btn-primary">ðŸ“¶ XView</button>
    <button id="btn_reset" type="button" class="btn btn-primary">ðŸ”„ Reset</button>
</div>
<hr/>
<div id="gridContainer" style="background-color: #515151">
    <div id='grid'></div>
    <div id='poppsp'></div>
</div>


<script>

    //const worker = perspective.worker();
    var notify_dur = 1200;
    // NAVIO  Step 1.  Create a Navio passing a d3 selection to place it and an optional height
    var nv = navio(d3.select("#nvx"), 600);

    $(document).ready(function () {
        nv.attribFontSize = 11;
        nv.nestedFilters = true;
        // NAVIO Step 2. Load your data!
        nv.data(data);

        // NAVIO Step 3. Detect your attributes (or load them manually)
        nv.addAllAttribs();

        // Optional, setup a selection callback
        //nv.updateCallback(selected => console.log("selected in Navio: ", selected.length));

        create_xgrid(data);

        // For Jupyter Notebook (Button to Open as New Window)
        if(window.location != window.parent.location)
        $("<a>", {target:"_blank", href:""}).text("[pop out]").prependTo($("body"));
    });

    function create_xgrid(data_in) {
        $("#grid").dxDataGrid({
            dataSource: data_in,
            //dataSource: "https://nicdatalab.com/api/MarketResearch",
            //dataSource: "https://jsonplaceholder.typicode.com/posts",
            columnWidth: 100,
            columnsAutoWidth: true,
            columnChooser: {allowSearch: true, enabled: true},
            // columnHidingEnabled: true,
            allowColumnReordering: true,
            allowColumnResizing: true,
            filterRow: {visible: true},
            filterPanel: {visible: true, filterEnabled: true},
            searchPanel: {visible: true},
            headerFilter: {visible: true},
            sorting: {mode: "multiple"},
            groupPanel: {visible: true},
            grouping: {autoExpandAll: false,},
            //scrolling: { columnRenderingMode: "virtual", scrollByThumb: true},
            showBorders: true,
            selection: {mode: 'multiple'},
            export:
                {
                    enabled: true,
                    fileName: 'DataExported.xlsx',
                    allowExportSelectedData: true,
                },
            paging: {pageSize: 25},
            pager: {showNavigationButtons: true, showPageSizeSelector: true},
            font: 6,
        });
    };


    function create_psp(data_in) {
        const worker = perspective.worker();
        const table = worker.table(data_in);
        const viewer = document.createElement("perspective-viewer");


        var gridArea = document.getElementById("pspcontainer");
        gridArea.appendChild(viewer);

        viewer.load(table);
    };


    function create_pivottablejs(data_in) {
        $(function () {
        //Set properties and initialize ejPivotClient widget
            var rendererslist = $.extend($.pivotUtilities.renderers,
                $.pivotUtilities.c3_renderers, 
                $.pivotUtilities.d3_renderers, 
                $.pivotUtilities.export_renderers);

            $("#grid").pivotUI(
                    data_in, 
                    {renderers: rendererslist}
                ).show();
        });
    };


    function create_ejpivot(data_in) {
        $(function () {
        //Set properties and initialize ejPivotClient widget
        $("#grid").ejPivotClient({
            dataSource: { data: data_in, enableAdvancedFilter: true},
            enableAdvancedFilter: true,
            enablePivotTreeMap: true,
            enableDrillThrough: true,
            enableCellClick: true,
            enableSplitter: true,
            
            displaySettings: { 
                controlPlacement: ej.PivotClient.ControlPlacement.Tab,
                mode: ej.PivotClient.DisplayMode.ChartAndGrid,
                enableTogglePanel: true,
                enableFullScreen: true,
            },
            toolbarIconSettings: {
                enableFullScreen: true,
                enableSortOrFilterColumn: true,
                enableSortOrFilterRow: true,
                enableCalculatedMember: true
            },
            isResponsive: true,
            enableVirtualScrolling: false,
            enableMeasureGroups : false,
            enableLocalStorage: true,
            beforeExport:"Export",
            clientExportMode: ej.PivotClient.ClientExportMode.ChartAndGrid,

        });
    });
    }

    function Export(args) {
            args.exportMode = ej.PivotClient.ExportMode.PivotEngine;
            args.fileFormat = ".xlsx"; //you can set the excel sheet format here
    }


    function create_xpivot(data_in, xPopup) {
        $("#grid").dxPivotGrid({
            allowSortingBySummary: true,
            allowFiltering: true,
            allowSorting: true,
            allowExpandAll: true,
            showBorders: true,
            showColumnGrandTotals: true,
            showRowGrandTotals: true,
            showRowTotals: true,
            showColumnTotals: true,
            fieldChooser: {
                enabled: true,
                height: 680
            },
            dataSource: data_in,
            onCellClick: function (e) {
                if (e.area == "data") {
                    var pivotGridDataSource = e.component.getDataSource(),
                        rowPathLength = e.cell.rowPath.length,
                        rowPathName = e.cell.rowPath[rowPathLength - 1],
                        popupTitle = (rowPathName ? rowPathName : "Total") + " Drill Down Data";

                    drillDownDataSource = pivotGridDataSource.createDrillDownDataSource(e.cell);
                    xPopup.option("title", popupTitle);
                    xPopup.show();
                }
            },
            fieldPanel: {
                showFilterFields: true,
                allowFieldDragging: true,
                visible: true
            },
            // onContextMenuPreparing: function (e) {
            //     var dataSource = e.component.getDataSource();
            //     if (e.field) {
            //         $.each(summaryDisplayModes, function (_, summaryDisplayMode) {
            //             var summaryDisplayModeValue = summaryDisplayMode.value;

            //             e.items.push({
            //                 text: summaryDisplayMode.text,
            //                 selected: e.field.summaryDisplayMode === summaryDisplayModeValue,
            //                 onItemClick: function () {
            //                     var format,
            //                         caption = summaryDisplayModeValue === "none" ? "Count" : summaryDisplayMode.text;
            //                     // if (summaryDisplayModeValue === "none" || summaryDisplayModeValue === "absoluteVariation") {
            //                     //     format = "currency";
            //                     // }
            //                     dataSource.field(e.field.index, {
            //                         summaryDisplayMode: summaryDisplayModeValue,
            //                         // format: format,
            //                         caption: caption
            //                     });

            //                     dataSource.load();
            //                 }
            //             });
            //         });
            //     }
            // },
            onContextMenuPreparing: function (e) {
                // Filtering off all non-data fields
                if (e.field && e.field.area == 'data') {
                    // Obtaining the PivotGrid's data source
                        var dataSource = e.component.getDataSource();
     
                    // Implementing a click event handler for the context menu items
                    var changeSummaryType = function (clickedItem) {
                        dataSource.field(e.field.index, {
                            summaryType: clickedItem.itemData.value
                        });
                        dataSource.load();
                    };
         
                    // Declaring an array of summary types to be present in the context menu
                    var items = [
                        { text: 'Sum', value: 'sum', onItemClick: changeSummaryType },
                        { text: 'Avg', value: 'avg', onItemClick: changeSummaryType },
                        { text: 'Min', value: 'min', onItemClick: changeSummaryType },
                        { text: 'Max', value: 'max', onItemClick: changeSummaryType },
                        { text: 'Count', value: 'count', onItemClick: changeSummaryType },
                        // { text: 'Custom', value: 'custom', onItemClick: changeSummaryType },
                    ];
         
                    // Applying the "selected" style to the item that represents the current summary type
                    $.each(items, function (_, item) {
                        if (item.value == dataSource.field(e.field.index).summaryType)
                            item.selected = true;
                    });
         
                    // Pushing the array of summary types to the array of context menu items
                    Array.prototype.push.apply(e.items, items)
                }
            }
        });
    };


    function create_drilldown() {
        $("#popup").dxPopup({
            width: 1680,
            height: 890,
            contentTemplate: function (contentElement) {
                $("<div />")
                    .addClass("drill-down")
                    .dxDataGrid({
                        width: "97%",
                        height: "97%",
                        columnWidth: 100,
                        columnsAutoWidth: true,
                        columnChooser: {allowSearch: true, enabled: true},
                        allowColumnReordering: true,
                        allowColumnResizing: true,
                        filterRow: {visible: true},
                        filterPanel: {visible: true, filterEnabled: true},
                        searchPanel: {visible: true},
                        headerFilter: {visible: true},
                        sorting: {mode: "multiple"},
                        groupPanel: {visible: true},
                        grouping: {autoExpandAll: false,},
                        scrolling: {columnRenderingMode: "virtual", scrollByThumb: true},
                        showBorders: true,
                        selection: {mode: 'multiple'},
                        export:
                            {
                                enabled: true,
                                fileName: 'ResearchData.xlsx',
                                allowExportSelectedData: true,
                            },
                        paging: {pageSize: 50},
                        pager: {showNavigationButtons: true, showPageSizeSelector: true},
                        font: 6,
                    })
                    .appendTo(contentElement);
            },
            onShowing: function () {
                $(".drill-down")
                    .dxDataGrid("instance")
                    .option("dataSource", drillDownDataSource);
            },
            onShown: function () {
                $(".drill-down")
                    .dxDataGrid("instance")
                    .updateDimensions();
            }
        });
    };

    var summaryDisplayModes = [
        {text: "None", value: "none"},
        {text: "Absolute Variation", value: "absoluteVariation"},
        {text: "Percent Variation", value: "percentVariation"},
        {text: "Percent of Column Total", value: "percentOfColumnTotal"},
        {text: "Percent of Row Total", value: "percentOfRowTotal"},
        {text: "Percent of Column Grand Total", value: "percentOfColumnGrandTotal"},
        {text: "Percent of Row Grand Total", value: "percentOfRowGrandTotal"},
        {text: "Percent of Grand Total", value: "percentOfGrandTotal"}
    ];


    $("#btn_togrid").dxButton({
        onClick: function (e) {

            datax = nv.getSelected();

            
            $("#popup").remove();
            $("#grid").remove();
            e = $('<div id="grid"></div>');
            $("#gridContainer").append(e);
            create_xgrid(datax);
            $("#grid").dxDataGrid("instance").refresh();


            DevExpress.ui.notify("XGrid Updated", "info", notify_dur);
        }
    });


    $("#btn_tobox").dxButton({
        onClick: function (e) {

            var instance = $("#grid").dxDataGrid("instance");

            // get hidden columns
            columnCount = instance.columnCount();
            var hiddenColumns = [];
            var i;
            for(i = 0; i < columnCount; i++) {  
                if(!instance.columnOption(i, "visible")) {  
                    hiddenColumns.push(instance.columnOption(i));  
                }  
            } 

            datax = instance.getSelectedRowsData();
            for(i = 0; i < hiddenColumns.length; i++){
                for(j=0; j < datax.length; j++)
                        delete datax[j][hiddenColumns[i].dataField];
            }
            // var filterExpr = instance.getCombinedFilter();
            // df = instance.getDataSource()
            // df.filter(filterExpr);
            $("#nvx").remove();
            e = $('<div id="nvx" style="background-color: #515151"></div>');
            $("#nvxContainer").append(e);

            nv = navio(d3.select("#nvx"), 600);
            nv.attribFontSize = 11;
            nv.data(datax);
            nv.addAllAttribs();
            nv.update();
            //nv.hardUpdate();
            DevExpress.ui.notify("XBox Updated", "info", notify_dur);
        }
    });


    // $("#btn_topsp").dxButton({
    //     onClick: function (e) {

    //         datax = nv.getSelected();
    //         $("#nvx").remove();
    //         $("#grid").remove();
    //         e = $('<div id="grid"></div>');
    //         $("#gridContainer").append(e);
    //         create_psp(datax);

    //         DevExpress.ui.notify("PSP Updated", "info", 700);
    //     }
    // });

    $("#btn_topsp").dxButton({
        onClick: function (e) {

            datax = nv.getSelected();

            $("#poppsp").dxPopup({
                title: "PSP",
                visible: true,
                closeOnOutsideClick: true,
                resizeEnabled: true,
                dragEnabled: true,
                fullScreen: false,
                minHeight: "99%",
                minWidth: "99%",
                showCloseButton:true,
                contentTemplate: function (contentElement) {
                    contentElement.append(
                        $('<div id="pspcontainer"></div>'))
                }
            });

            create_psp(datax);
            DevExpress.ui.notify("PSP Updated", "info", notify_dur);
        }
    });


    $("#btn_topivot").dxButton({
        onClick: function (e) {

            datax = nv.getSelected();
            $("#grid").remove();
            $("#popup").remove();
            e = $('<div id="grid"></div>');
            $("#gridContainer").append(e);

            e = $('<div id="popup"></div>');
            $("#gridContainer").append(e);

            create_drilldown()
            var xPopup = $("#popup").dxPopup("instance");

            create_xpivot(datax, xPopup);
            DevExpress.ui.notify("Xpivot Updated", "info", notify_dur);
        }
    });


    $("#btn_toejpivot").dxButton({
        onClick: function (e) {

            datax = nv.getSelected();
            $("#grid").remove();
            $("#popup").remove();
            e = $('<div id="grid"></div>');
            $("#gridContainer").append(e);


            // create_ejpivot(datax);
            create_pivottablejs(datax);
            DevExpress.ui.notify("EJpivot Updated", "info", notify_dur);
        }
    });


    $("#btn_reset").dxButton({
        onClick: function (e) {
            $("#nvx").remove();
            e = $('<div id="nvx" style="background-color: #515151"></div>');
            $("#nvxContainer").append(e);
            nv = navio(d3.select("#nvx"), 600);
            nv.attribFontSize = 11
            nv.data(data);
            nv.addAllAttribs();
            nv.hardUpdate();

            $("#popup").remove();
            $("#grid").remove();
            e = $('<div id="grid"></div>');
            $("#gridContainer").append(e);
            create_xgrid(data);
            $("#grid").dxDataGrid("instance").refresh();


            DevExpress.ui.notify("Data Reset Completed", "info", notify_dur);
        }
    });

    e="insert_data_here";
</script>

<style type="text/css">
    #drop-area {
        border: 1px solid #ccc;
        width: 480px;
        font-family: sans-serif;
        margin: 100px auto;
        padding: 48px;
    }

    #drop-area.highlight { border-color: purple;}

    p { margin-top: 0; }

    .my-form { margin-bottom: 10px; }

    #gallery { margin-top: 10px; }

    #gallery img {
        width: 150px;
        margin-bottom: 10px;
        margin-right: 10px;
        vertical-align: middle;
    }

    .button {
        display: inline-block;
        padding: 10px;
        background: #ccc;
        cursor: pointer;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .button:hover { background: #ddd; }

    #fileElem { display: none;}

    perspective-viewer {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
    }

</style>

</body>

</html>